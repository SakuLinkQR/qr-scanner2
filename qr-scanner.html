<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Code Scanner</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

  <!-- ヘッダー -->
  <div class="header-bar">
    <div class="header-inner">
      <div class="logo">🌸 SakuLink 🌸</div>
      <div class="hamburger" onclick="toggleMenu()">📖 MENU ☰</div>
    </div>
  </div>

  <!-- メニュー -->
  <div class="menu" id="menu">
    <a href="index.html">🏠 Home</a>
    <a href="reading_list.html">📚 Readings</a>
    <a href="#" onclick="logout()">🚪 Logout</a>
  </div>

  <!-- タイトル -->
  <h1 style="text-align: center;">QR Code Scanner</h1>

  <!-- スキャナー表示領域 -->
  <div id="reader" style="width: 300px; margin: auto;"></div>

  <!-- ホームへ戻るボタン -->
  <div style="text-align: center; margin-top: 20px;">
    <a href="index.html">
      <button style="padding: 10px 20px; font-size: 16px;">🏠 Back to Home</button>
    </a>
  </div>

  <script>
    // トークン有効性チェック（保護ページとして機能）
    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("authToken");
      if (!token) {
        window.location.href = "index.html";
        return;
      }

      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const now = Math.floor(Date.now() / 1000);
        if (payload.exp && payload.exp < now) {
          localStorage.removeItem("authToken");
          window.location.href = "index.html";
        }
      } catch (e) {
        localStorage.removeItem("authToken");
        window.location.href = "index.html";
      }
    });

    // メニュー表示切替
    function toggleMenu() {
      const menu = document.getElementById("menu");
      menu.classList.toggle("show");
    }

    // ログアウト機能
    function logout() {
      localStorage.removeItem("authToken");
      window.location.href = "index.html";
    }

    // QRコードスキャン初期化
    const html5QrCode = new Html5Qrcode("reader");
    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
      html5QrCode.stop().then(() => {
        window.location.href = `dish_detail.html?id=${decodedText}`;
      }).catch(err => {
        console.error("停止エラー", err);
      });
    };

    const config = { fps: 10, qrbox: 250 };

    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
      }
    }).catch(err => {
      console.error("カメラ取得エラー", err);
    });
  </script>
</body>
</html>
