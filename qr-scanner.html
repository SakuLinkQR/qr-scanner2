<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Code Scanner</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header-bar">
    <div class="header-inner">
      <div class="logo">ğŸŒ¸ SakuLink ğŸŒ¸</div>
      <div class="hamburger" onclick="toggleMenu()">ğŸ“– MENU â˜°</div>
    </div>
  </div>

  <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div class="menu" id="menu">
    <a href="index.html">ğŸ  Home</a>
    <a href="reading_list.html">ğŸ“š Readings</a>
    <a href="#" onclick="logout()">ğŸšª Logout</a>
  </div>

  <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
  <h1 style="text-align: center;">QR Code Scanner</h1>

  <!-- ã‚¹ã‚­ãƒ£ãƒŠãƒ¼è¡¨ç¤ºé ˜åŸŸ -->
  <div id="reader" style="width: 300px; margin: auto;"></div>

  <!-- ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
  <div style="text-align: center; margin-top: 20px;">
    <a href="index.html">
      <button style="padding: 10px 20px; font-size: 16px;">ğŸ  Back to Home</button>
    </a>
  </div>

  <script>
    // ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆä¿è­·ãƒšãƒ¼ã‚¸ã¨ã—ã¦æ©Ÿèƒ½ï¼‰
    document.addEventListener("DOMContentLoaded", () => {
      const token = localStorage.getItem("authToken");
      if (!token) {
        window.location.href = "index.html";
        return;
      }

      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const now = Math.floor(Date.now() / 1000);
        if (payload.exp && payload.exp < now) {
          localStorage.removeItem("authToken");
          window.location.href = "index.html";
        }
      } catch (e) {
        localStorage.removeItem("authToken");
        window.location.href = "index.html";
      }
    });

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºåˆ‡æ›¿
    function toggleMenu() {
      const menu = document.getElementById("menu");
      menu.classList.toggle("show");
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
    function logout() {
      localStorage.removeItem("authToken");
      window.location.href = "index.html";
    }

    // QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³åˆæœŸåŒ–
    const html5QrCode = new Html5Qrcode("reader");
    const qrCodeSuccessCallback = (decodedText, decodedResult) => {
      html5QrCode.stop().then(() => {
        window.location.href = `dish_detail.html?id=${decodedText}`;
      }).catch(err => {
        console.error("åœæ­¢ã‚¨ãƒ©ãƒ¼", err);
      });
    };

    const config = { fps: 10, qrbox: 250 };

    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback);
      }
    }).catch(err => {
      console.error("ã‚«ãƒ¡ãƒ©å–å¾—ã‚¨ãƒ©ãƒ¼", err);
    });
  </script>
</body>
</html>
