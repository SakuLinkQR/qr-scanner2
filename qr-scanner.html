<script>
  const resultContainer = document.getElementById("output");

  function onScanSuccess(decodedText, decodedResult) {
    let idCode = decodedText;

    // URL形式なら id_code を抽出する
    if (decodedText.includes("id_code=")) {
      const match = decodedText.match(/id_code=([^&]+)/);
      if (match) {
        idCode = match[1];
      }
    }

    resultContainer.innerText = idCode;
    window.location.href = `https://sakulinkqr.github.io/dish-pages/index.html?id_code=${idCode}`;
  }

  function onScanFailure(error) {
    // スキャン失敗時の処理（オプション）
  }

  const html5QrCode = new Html5Qrcode("preview");
  Html5Qrcode.getCameras().then(cameras => {
    if (cameras && cameras.length) {
      // 背面カメラ優先
      const backCamera = cameras.find(c => c.label.toLowerCase().includes('back')) || cameras[0];

      html5QrCode.start(
        backCamera.id,
        {
          fps: 10,
          qrbox: 250
        },
        onScanSuccess,
        onScanFailure
      );
    } else {
      alert("No camera found on this device.");
    }
  }).catch(err => {
    alert("Camera access error: " + err);
  });
</script>
